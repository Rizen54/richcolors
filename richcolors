#!/usr/bin/env python3

import argparse
import re

import PIL.ImageDraw as ImageDraw
import PIL.Image as Image


def parse_hex_codes(filename):
    """Parses a text file for hex color codes.

    Args:
        filename: The name of the input file.

    Returns:
        A list of hex color codes found in the file.
    """

    hex_code_pattern = r"#[0-9a-fA-F]{6}"
    hex_codes = []

    try:
        with open(filename, "r") as f:
            for line in f:
                matches = re.findall(hex_code_pattern, line)
                hex_codes.extend(matches)
    except FileNotFoundError:
        print(f"Error: File '{filename}' not found.")
    except Exception as e:
        print(f"Error parsing file: {e}")

    return hex_codes


def visualize_palette(hex_codes, rect_width, rect_height, max_columns=8, background_color="#0c0f1c", border_color="#0c0f1c", padding=5, outline_width=5):
    """Visualizes a color palette from hex codes.

    Args:
        hex_codes: A list of hex color codes.
        rect_width: Width of each rectangle.
        rect_height: Height of each rectangle.
        spacing: Spacing between rectangles.
        max_columns: Maximum number of columns in the table.
        background_color: Background color of the image.
        border_color: Border color of the rectangles.
        padding: Padding around the rectangle group.
        outline_width: Width of the rectangle outline.

    Returns:
        The created image.
    """

    num_colors = len(hex_codes)

    # Calculate the number of rows and columns needed
    num_columns = min(num_colors, max_columns)
    num_rows = (num_colors + num_columns - 1) // num_columns

    # Calculate the overall image dimensions based on the rectangle dimensions, spacing, and padding
    image_width = num_columns * rect_width + (num_columns - 1) + 2 * padding
    image_height = num_rows * rect_height + (num_rows - 1) + 2 * padding

    img = Image.new('RGB', (image_width, image_height), background_color)  # Set background color
    draw = ImageDraw.Draw(img)

    # Draw the padding rectangle
    draw.rectangle([(0, 0), (image_width, image_height)], outline=border_color)

    x, y = padding, padding  # Start drawing rectangles inside the padding
    for hex_code in hex_codes:
        # Remove '#' if present
        hex_code = hex_code.lstrip('#')

        color = tuple(int(hex_code[i:i+2], 16) for i in (0, 2, 4))

        # Draw the rectangle with a border of specified width
        draw.rectangle([(x, y), (x + rect_width, y + rect_height)], fill=color, outline=border_color, width=outline_width)
        x += rect_width

        if x + rect_width >= image_width - padding:
            x = padding
            y += rect_height

    return img

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Visualize a color palette from hex codes.")
    parser.add_argument("hex_codes_file", help="Path to the file containing hex codes.")
    parser.add_argument("image_name", help="Name of the output image file.")
    args = parser.parse_args()

    hex_codes = parse_hex_codes(args.hex_codes_file)

    if hex_codes:
        rect_width = 50
        rect_height = 30

        img = visualize_palette(hex_codes, rect_width, rect_height)

        img.save(args.image_name)
        print("Image saved as", args.image_name)
    else:
        print("No hex codes found in the file.")
